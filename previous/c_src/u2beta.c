#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "compearth.h"

static const int nbs = 1000;
static int compearth_u2beta_findPoint(const double u, const int guessIn);
static void compearth_u2beta_linearlyInterpolate(const int nb, 
                                                 const double *__restrict__ u,
                                                 const int *__restrict__ indx,
                                                 double *__restrict__ b);

/*!
 * @brief Computes beta lune colatitude from u by solving Eqn 24a of Tape and
 *        Tape, 2015.  This computes the inverse of the montonically increasing
 *        function u using linear interpolation. 
 *
 * @param[in] n      Number of points.
 * @param[in] u      u coordinates in the range \f$ [0, 3*pi/4] \f$.  This is an
 *                   array of dimension [n].
 *
 * @param[out] beta  Colalitudes in the range \f$ [0, \pi] \f$.  This is an
 *                   array of dimension [n].
 *
 * @result 0 indicates success.
 *
 */
int compearth_u2beta(const int n, const double *__restrict__ u,
                     double *__restrict__ beta)
{
    int guess[CE_CHUNKSIZE], i, j, nbLoc;
    memset(guess, 0, CE_CHUNKSIZE*sizeof(int));
    for (i=0; i<n; i=i+CE_CHUNKSIZE)
    {
        nbLoc = MIN(CE_CHUNKSIZE, n - i);
        for (j=0; j<nbLoc; j++)
        {
            if (j > 0)
            {
                guess[j] = compearth_u2beta_findPoint(u[i+j], guess[j-1]);
            }
            else
            {
                guess[j] = compearth_u2beta_findPoint(u[i+j], 0);
            }
            if (guess[j] < 0 || guess[j] > nbs - 2)
            {
                fprintf(stderr, "%s: Algorithm failure\n", __func__);
                return -1; 
            }
       }
       compearth_u2beta_linearlyInterpolate(nbLoc, &u[i], guess, &beta[i]);
    }
    return 0;
}
/*!
 * @brief Computes beta lune colatitude from u.  This applies the inverse
 *        of Equation 24a of Tape and Tape 2015 
 *
 * @param[in] n          Number of points.
 * @param[in] maxit      Max number of iterations.
 * @param[in] linvType   If =1 -> Newton-Rhapson iteration. \n
 *                       Otherwise -> Halley iteration (default).
 * @param[in] u          u coordinates in the range \f$ [0, 3*pi/4] \f$.  
 *                       this is an array of dimension [n].
 * @param[in] tol        Convergence is achieved when:
 *                         fabs(u - 0.75*beta - 0.5*sin2b + 0.0625*sin4b) < tol
 *
 * @param[out] beta      Colalitudes in the range \f$ [0, \pi] \f$.  This
 *                       is an array of dimension [n].
 *
 * @result 0 indicates success
 *
 * @author Ben Baker
 *
 * @copyright ISTI distributed under MIT
 *
 * @bug there is an issue with small angle approximations near the endpoints
 *
 */
int compearth_u2beta_optimize(const int n,
                              const int maxit,
                              const int linvType,
                              const double *__restrict__ u,
                              const double tol,
                              double *__restrict__ beta)
{
    const int nb = 16;
    const double betas[16] = {0.0000000000, 0.1682996064, 0.3365992129,
                              0.5048988193, 0.6731984258, 0.8414980322,
                              1.0097976387, 1.1780972451, 1.3463968515,
                              1.5146964580, 1.6829960644, 1.8512956709,
                              2.0195952773, 2.1878948838, 2.3561944902,
                              2.3561944902};
    const double us[16] = {0.0000000000, 0.0000532865,
                           0.0016375032, 0.0116225691,
                           0.0445525969, 0.1203598608,
                           0.2579993274, 0.4675195432,
                           0.7439913014, 1.0661325471,
                           1.4006252490, 1.7107983457,
                           1.9665451937, 2.1518309406,
                           2.2671458676, 100.0};
    double absBetaNew, betaNew, betaWork, c, cos2b, cos4b,
           den, dfdx, dfdx2, f, sin2b, sin4b;
    int i, ierr, indx, k;
    bool lconv;
    const double lowerBound = 0.0 + 0.144;
    const double upperBound = 0.75*M_PI - 0.144;
    ierr = 0;
    betaWork = 0.0;
#ifdef USE_OPENMP
  #pragma omp parallel for \
  firstprivate(betaWork), \
  private (betaNew, c, cos2b, cos4b, den, dfdx, dfdx2,  \
           f, i, indx, k, lconv, sin2b, sin4b)  \
  shared (beta, betas, lowerBound, u, upperBound ) \
  reduction (max:ierr) \
  default (none)
#endif
    for (i=0; i<n; i++)
    {
        // Edge cases
        ierr = 0;
        if (u[i] < lowerBound || fabs(u[i] - lowerBound) < tol/2.0)
        {
            beta[i] = fmax(0, u[i]); //TODO need small angle approximation
            if (u[i] <= 0.0)
            {
                beta[i] = 0.0;
                continue;
            }
            // Taylor expansion of function is: 
            // u = 2/5*beta^5 - 4/21*beta^7 + 2/45*beta^9 + ...
            // but this doesn't work so great
            beta[i] = pow(2.5*u[i], 0.2);
            continue; // There will be a lot of complaints if this is removed
//compearth_beta2u(1, &beta[i], &f);
//printf("diff: %e %e\n", f - u[i], u[i]);
//            continue;
        }
        if (u[i] > upperBound || fabs(u[i] - upperBound) < tol/2.0)
        {
            // TODO need small angle approximation
            beta[i] = fmax(M_PI, M_PI - fabs(us[nb-2] - u[i]));
            if (u[i] >= 0.75*M_PI)
            {
                beta[i] = M_PI;
                continue;
            }
            //continue;            
//compearth_beta2u(1, &beta[i], &f);
//printf("diff: %e %f\n", f - u[i], u[i]);
//            continue;
        }
        // Bracket the solution 
        indx = 0;
        for (k=0; k<nb-1; k++)
        {
            if (us[k] < u[i] && u[i] < us[k+1])
            {
                indx = k;
                break;
            }
        }
        if (k < nb)
        {
            // try to take closer interval
            if (k < nb - 1)
            {
                if (fabs(us[k+1] - u[i]) < fabs(us[k] - u[i])){indx = k + 1;}
            }
            betaWork = betas[indx];
        }
        else
        {
            fprintf(stderr, "%s: Failed to bracket solution %d\n", __func__, i);
            betaWork = 0.5*(upperBound + lowerBound);
        }
        // Begin Newton-Rhapson iteration
        lconv = false;
        if (linvType == 1)
        {
            for (k=0; k<maxit; k++)
            {
                //f = tape2015_beta2u(betaWork) - u;
                compearth_beta2u(1, &betaWork, &f);
                f = f - u[i];
                // Primary convergence check
                if (fabs(f) < tol)
                {
                    lconv = true;
                    beta[i] = betaWork;
                    break;
                }
                cos2b = cos(2.0*betaWork);
                cos4b = cos(4.0*betaWork);
                dfdx = 0.75 - cos2b + 0.25*cos4b;
                // Avoid a breakdown in Newton Rhapson
                if (fabs(dfdx) < 1.e-15)
                {
                    fprintf(stderr, "%s: Division by zero: %f\n",
                            __func__, fabs(dfdx));
                    lconv = false;
                    break;
                }
                betaNew = betaWork - f/dfdx; // Newton-Rhapson iteration
                absBetaNew = fabs(betaNew);
                if (fabs(betaNew - betaWork)/absBetaNew < tol)
                {
                    lconv = true;
                    beta[i] = betaWork;
                    break; 
                }
                betaWork = betaNew;
            } // Loop on iterations
        }
        // Begin Halley iteration
        else
        {
            for (k=0; k<maxit; k++)
            {
                sin2b = sin(2.0*betaWork);
                sin4b = sin(4.0*betaWork);
                f = 0.75*betaWork - 0.5*sin2b + 0.0625*sin4b - u[i];
                // Primary convergence check
                if (fabs(f) < tol)
                {
                    lconv = true;
                    beta[i] = betaWork;
                    break;
                }
                cos2b = cos(2.0*betaWork);
                cos4b = cos(4.0*betaWork);
                dfdx = 0.75 - cos2b + 0.25*cos4b;
                dfdx2 = 2.0*sin2b - sin4b;
                den = 2.0*dfdx*dfdx - f*dfdx2;
                if (fabs(den) < 1.e-15)
                {
                    fprintf(stderr, "%s: Division by zero: %e; res=%e\n",
                            __func__, fabs(den), f);
                    lconv = false;
                    break;
                }
                c = 2.0*f*dfdx/den;
                if (fabs(dfdx) < tol)
                {
                   lconv = true;
                   beta[i] = betaWork;
                   break;
                }
                betaNew = betaWork - c; // Halley iteration
                // Require iteration making good progress
                absBetaNew = fabs(betaNew);
                if (fabs(betaNew - betaWork)/absBetaNew < tol)
                {
                    lconv = true;
                    beta[i] = betaWork;
                    break;
                }
                betaWork = betaNew;
            }
        } // End check on halley vs newton
        // check convergence
        if (!lconv)
        {
printf("%e %e\n", u[i], lowerBound);
            compearth_beta2u(1, &betaWork, &f);
            fprintf(stderr,
                    "%s: Failure to converge after %d iterations %d %f %f\n",
                    __func__, maxit, i, f, u[i]);
            ierr = 1;
            beta[i] = 0.0;
        }
        //compearth_beta2u(1, &beta[i], &f);
        //printf("solved: diff: %e %e\n", f - u[i], u[i]);
    }
    return ierr;
}

static const void *last_visited = NULL;
static int cmp_double_ascending(const void *x, const void *y) 
{
    const double xx = *(const double *) x;
    const double yy = *(const double *) y;
    last_visited = (const void *) y;
    if (xx < yy) return -1; 
    if (xx > yy) return  1;  
    return 0;
}

static const double betas[1000] = {0.000000000000000,
     0.003144737390981,0.006289474781962,0.009434212172942,0.012578949563923,
     0.015723686954904,0.018868424345885,0.022013161736865,0.025157899127846,
     0.028302636518827,0.031447373909808,0.034592111300789,0.037736848691769,
     0.040881586082750,0.044026323473731,0.047171060864712,0.050315798255692,
     0.053460535646673,0.056605273037654,0.059750010428635,0.062894747819615,
     0.066039485210596,0.069184222601577,0.072328959992558,0.075473697383539,
     0.078618434774519,0.081763172165500,0.084907909556481,0.088052646947462,
     0.091197384338442,0.094342121729423,0.097486859120404,0.100631596511385,
     0.103776333902366,0.106921071293346,0.110065808684327,0.113210546075308,
     0.116355283466289,0.119500020857269,0.122644758248250,0.125789495639231,
     0.128934233030212,0.132078970421192,0.135223707812173,0.138368445203154,
     0.141513182594135,0.144657919985116,0.147802657376096,0.150947394767077,
     0.154092132158058,0.157236869549039,0.160381606940019,0.163526344331000,
     0.166671081721981,0.169815819112962,0.172960556503943,0.176105293894923,
     0.179250031285904,0.182394768676885,0.185539506067866,0.188684243458846,
     0.191828980849827,0.194973718240808,0.198118455631789,0.201263193022770,
     0.204407930413750,0.207552667804731,0.210697405195712,0.213842142586693,
     0.216986879977673,0.220131617368654,0.223276354759635,0.226421092150616,
     0.229565829541596,0.232710566932577,0.235855304323558,0.239000041714539,
     0.242144779105520,0.245289516496500,0.248434253887481,0.251578991278462,
     0.254723728669443,0.257868466060423,0.261013203451404,0.264157940842385,
     0.267302678233366,0.270447415624347,0.273592153015327,0.276736890406308,
     0.279881627797289,0.283026365188270,0.286171102579250,0.289315839970231,
     0.292460577361212,0.295605314752193,0.298750052143174,0.301894789534154,
     0.305039526925135,0.308184264316116,0.311329001707097,0.314473739098077,
     0.317618476489058,0.320763213880039,0.323907951271020,0.327052688662000,
     0.330197426052981,0.333342163443962,0.336486900834943,0.339631638225924,
     0.342776375616904,0.345921113007885,0.349065850398866,0.352210587789847,
     0.355355325180827,0.358500062571808,0.361644799962789,0.364789537353770,
     0.367934274744751,0.371079012135731,0.374223749526712,0.377368486917693,
     0.380513224308674,0.383657961699654,0.386802699090635,0.389947436481616,
     0.393092173872597,0.396236911263577,0.399381648654558,0.402526386045539,
     0.405671123436520,0.408815860827501,0.411960598218481,0.415105335609462,
     0.418250073000443,0.421394810391424,0.424539547782404,0.427684285173385,
     0.430829022564366,0.433973759955347,0.437118497346328,0.440263234737308,
     0.443407972128289,0.446552709519270,0.449697446910251,0.452842184301231,
     0.455986921692212,0.459131659083193,0.462276396474174,0.465421133865154,
     0.468565871256135,0.471710608647116,0.474855346038097,0.478000083429078,
     0.481144820820058,0.484289558211039,0.487434295602020,0.490579032993001,
     0.493723770383981,0.496868507774962,0.500013245165943,0.503157982556924,
     0.506302719947905,0.509447457338885,0.512592194729866,0.515736932120847,
     0.518881669511828,0.522026406902808,0.525171144293789,0.528315881684770,
     0.531460619075751,0.534605356466732,0.537750093857712,0.540894831248693,
     0.544039568639674,0.547184306030655,0.550329043421635,0.553473780812616,
     0.556618518203597,0.559763255594578,0.562907992985558,0.566052730376539,
     0.569197467767520,0.572342205158501,0.575486942549482,0.578631679940462,
     0.581776417331443,0.584921154722424,0.588065892113405,0.591210629504385,
     0.594355366895366,0.597500104286347,0.600644841677328,0.603789579068309,
     0.606934316459289,0.610079053850270,0.613223791241251,0.616368528632232,
     0.619513266023212,0.622658003414193,0.625802740805174,0.628947478196155,
     0.632092215587135,0.635236952978116,0.638381690369097,0.641526427760078,
     0.644671165151059,0.647815902542039,0.650960639933020,0.654105377324001,
     0.657250114714982,0.660394852105962,0.663539589496943,0.666684326887924,
     0.669829064278905,0.672973801669886,0.676118539060866,0.679263276451847,
     0.682408013842828,0.685552751233809,0.688697488624789,0.691842226015770,
     0.694986963406751,0.698131700797732,0.701276438188713,0.704421175579693,
     0.707565912970674,0.710710650361655,0.713855387752636,0.717000125143616,
     0.720144862534597,0.723289599925578,0.726434337316559,0.729579074707539,
     0.732723812098520,0.735868549489501,0.739013286880482,0.742158024271463,
     0.745302761662443,0.748447499053424,0.751592236444405,0.754736973835386,
     0.757881711226366,0.761026448617347,0.764171186008328,0.767315923399309,
     0.770460660790290,0.773605398181270,0.776750135572251,0.779894872963232,
     0.783039610354213,0.786184347745193,0.789329085136174,0.792473822527155,
     0.795618559918136,0.798763297309117,0.801908034700097,0.805052772091078,
     0.808197509482059,0.811342246873040,0.814486984264020,0.817631721655001,
     0.820776459045982,0.823921196436963,0.827065933827943,0.830210671218924,
     0.833355408609905,0.836500146000886,0.839644883391867,0.842789620782847,
     0.845934358173828,0.849079095564809,0.852223832955790,0.855368570346770,
     0.858513307737751,0.861658045128732,0.864802782519713,0.867947519910694,
     0.871092257301674,0.874236994692655,0.877381732083636,0.880526469474617,
     0.883671206865597,0.886815944256578,0.889960681647559,0.893105419038540,
     0.896250156429521,0.899394893820501,0.902539631211482,0.905684368602463,
     0.908829105993444,0.911973843384424,0.915118580775405,0.918263318166386,
     0.921408055557367,0.924552792948347,0.927697530339328,0.930842267730309,
     0.933987005121290,0.937131742512271,0.940276479903251,0.943421217294232,
     0.946565954685213,0.949710692076194,0.952855429467174,0.956000166858155,
     0.959144904249136,0.962289641640117,0.965434379031098,0.968579116422078,
     0.971723853813059,0.974868591204040,0.978013328595021,0.981158065986001,
     0.984302803376982,0.987447540767963,0.990592278158944,0.993737015549924,
     0.996881752940905,1.000026490331886,1.003171227722867,1.006315965113848,
     1.009460702504828,1.012605439895809,1.015750177286790,1.018894914677771,
     1.022039652068751,1.025184389459732,1.028329126850713,1.031473864241694,
     1.034618601632675,1.037763339023655,1.040908076414636,1.044052813805617,
     1.047197551196598,1.050342288587578,1.053487025978559,1.056631763369540,
     1.059776500760521,1.062921238151501,1.066065975542482,1.069210712933463,
     1.072355450324444,1.075500187715425,1.078644925106405,1.081789662497386,
     1.084934399888367,1.088079137279348,1.091223874670328,1.094368612061309,
     1.097513349452290,1.100658086843271,1.103802824234251,1.106947561625232,
     1.110092299016213,1.113237036407194,1.116381773798175,1.119526511189155,
     1.122671248580136,1.125815985971117,1.128960723362098,1.132105460753078,
     1.135250198144059,1.138394935535040,1.141539672926021,1.144684410317002,
     1.147829147707983,1.150973885098963,1.154118622489944,1.157263359880925,
     1.160408097271906,1.163552834662886,1.166697572053867,1.169842309444848,
     1.172987046835829,1.176131784226809,1.179276521617790,1.182421259008771,
     1.185565996399752,1.188710733790733,1.191855471181713,1.195000208572694,
     1.198144945963675,1.201289683354656,1.204434420745636,1.207579158136617,
     1.210723895527598,1.213868632918579,1.217013370309559,1.220158107700540,
     1.223302845091521,1.226447582482502,1.229592319873483,1.232737057264463,
     1.235881794655444,1.239026532046425,1.242171269437406,1.245316006828386,
     1.248460744219367,1.251605481610348,1.254750219001329,1.257894956392309,
     1.261039693783290,1.264184431174271,1.267329168565252,1.270473905956233,
     1.273618643347213,1.276763380738194,1.279908118129175,1.283052855520156,
     1.286197592911136,1.289342330302117,1.292487067693098,1.295631805084079,
     1.298776542475059,1.301921279866040,1.305066017257021,1.308210754648002,
     1.311355492038983,1.314500229429963,1.317644966820944,1.320789704211925,
     1.323934441602906,1.327079178993886,1.330223916384867,1.333368653775848,
     1.336513391166829,1.339658128557810,1.342802865948790,1.345947603339771,
     1.349092340730752,1.352237078121733,1.355381815512714,1.358526552903694,
     1.361671290294675,1.364816027685656,1.367960765076637,1.371105502467617,
     1.374250239858598,1.377394977249579,1.380539714640560,1.383684452031540,
     1.386829189422521,1.389973926813502,1.393118664204483,1.396263401595464,
     1.399408138986444,1.402552876377425,1.405697613768406,1.408842351159387,
     1.411987088550367,1.415131825941348,1.418276563332329,1.421421300723310,
     1.424566038114290,1.427710775505271,1.430855512896252,1.434000250287233,
     1.437144987678214,1.440289725069194,1.443434462460175,1.446579199851156,
     1.449723937242137,1.452868674633117,1.456013412024098,1.459158149415079,
     1.462302886806060,1.465447624197040,1.468592361588021,1.471737098979002,
     1.474881836369983,1.478026573760964,1.481171311151944,1.484316048542925,
     1.487460785933906,1.490605523324887,1.493750260715867,1.496894998106848,
     1.500039735497829,1.503184472888810,1.506329210279790,1.509473947670771,
     1.512618685061752,1.515763422452733,1.518908159843714,1.522052897234695,
     1.525197634625675,1.528342372016656,1.531487109407637,1.534631846798618,
     1.537776584189598,1.540921321580579,1.544066058971560,1.547210796362541,
     1.550355533753522,1.553500271144502,1.556645008535483,1.559789745926464,
     1.562934483317445,1.566079220708425,1.569223958099406,1.572368695490387,
     1.575513432881368,1.578658170272348,1.581802907663329,1.584947645054310,
     1.588092382445291,1.591237119836272,1.594381857227252,1.597526594618233,
     1.600671332009214,1.603816069400195,1.606960806791175,1.610105544182156,
     1.613250281573137,1.616395018964118,1.619539756355098,1.622684493746079,
     1.625829231137060,1.628973968528041,1.632118705919022,1.635263443310002,
     1.638408180700983,1.641552918091964,1.644697655482945,1.647842392873925,
     1.650987130264906,1.654131867655887,1.657276605046868,1.660421342437848,
     1.663566079828829,1.666710817219810,1.669855554610791,1.673000292001772,
     1.676145029392752,1.679289766783733,1.682434504174714,1.685579241565695,
     1.688723978956675,1.691868716347656,1.695013453738637,1.698158191129618,
     1.701302928520599,1.704447665911579,1.707592403302560,1.710737140693541,
     1.713881878084522,1.717026615475503,1.720171352866483,1.723316090257464,
     1.726460827648445,1.729605565039426,1.732750302430406,1.735895039821387,
     1.739039777212368,1.742184514603349,1.745329251994329,1.748473989385310,
     1.751618726776291,1.754763464167272,1.757908201558253,1.761052938949233,
     1.764197676340214,1.767342413731195,1.770487151122176,1.773631888513156,
     1.776776625904137,1.779921363295118,1.783066100686099,1.786210838077079,
     1.789355575468060,1.792500312859041,1.795645050250022,1.798789787641003,
     1.801934525031983,1.805079262422964,1.808223999813945,1.811368737204926,
     1.814513474595906,1.817658211986887,1.820802949377868,1.823947686768849,
     1.827092424159829,1.830237161550810,1.833381898941791,1.836526636332772,
     1.839671373723753,1.842816111114733,1.845960848505714,1.849105585896695,
     1.852250323287676,1.855395060678656,1.858539798069637,1.861684535460618,
     1.864829272851599,1.867974010242579,1.871118747633560,1.874263485024541,
     1.877408222415522,1.880552959806503,1.883697697197483,1.886842434588464,
     1.889987171979445,1.893131909370426,1.896276646761407,1.899421384152387,
     1.902566121543368,1.905710858934349,1.908855596325330,1.912000333716311,
     1.915145071107291,1.918289808498272,1.921434545889253,1.924579283280234,
     1.927724020671214,1.930868758062195,1.934013495453176,1.937158232844157,
     1.940302970235137,1.943447707626118,1.946592445017099,1.949737182408080,
     1.952881919799061,1.956026657190041,1.959171394581022,1.962316131972003,
     1.965460869362984,1.968605606753964,1.971750344144945,1.974895081535926,
     1.978039818926907,1.981184556317887,1.984329293708868,1.987474031099849,
     1.990618768490830,1.993763505881811,1.996908243272791,2.000052980663772,
     2.003197718054753,2.006342455445734,2.009487192836714,2.012631930227695,
     2.015776667618676,2.018921405009657,2.022066142400638,2.025210879791618,
     2.028355617182599,2.031500354573580,2.034645091964561,2.037789829355541,
     2.040934566746522,2.044079304137503,2.047224041528484,2.050368778919464,
     2.053513516310445,2.056658253701426,2.059802991092407,2.062947728483388,
     2.066092465874368,2.069237203265349,2.072381940656330,2.075526678047311,
     2.078671415438291,2.081816152829272,2.084960890220253,2.088105627611234,
     2.091250365002214,2.094395102393195,2.097539839784176,2.100684577175157,
     2.103829314566138,2.106974051957118,2.110118789348099,2.113263526739080,
     2.116408264130061,2.119553001521041,2.122697738912022,2.125842476303003,
     2.128987213693984,2.132131951084964,2.135276688475945,2.138421425866926,
     2.141566163257907,2.144710900648888,2.147855638039868,2.151000375430849,
     2.154145112821830,2.157289850212811,2.160434587603791,2.163579324994772,
     2.166724062385753,2.169868799776734,2.173013537167714,2.176158274558695,
     2.179303011949676,2.182447749340657,2.185592486731638,2.188737224122618,
     2.191881961513599,2.195026698904580,2.198171436295561,2.201316173686541,
     2.204460911077522,2.207605648468503,2.210750385859484,2.213895123250465,
     2.217039860641445,2.220184598032426,2.223329335423407,2.226474072814388,
     2.229618810205368,2.232763547596349,2.235908284987330,2.239053022378311,
     2.242197759769291,2.245342497160272,2.248487234551253,2.251631971942234,
     2.254776709333215,2.257921446724195,2.261066184115176,2.264210921506157,
     2.267355658897138,2.270500396288119,2.273645133679099,2.276789871070080,
     2.279934608461061,2.283079345852042,2.286224083243023,2.289368820634003,
     2.292513558024984,2.295658295415965,2.298803032806946,2.301947770197927,
     2.305092507588907,2.308237244979888,2.311381982370869,2.314526719761850,
     2.317671457152830,2.320816194543811,2.323960931934792,2.327105669325773,
     2.330250406716753,2.333395144107734,2.336539881498715,2.339684618889696,
     2.342829356280677,2.345974093671657,2.349118831062638,2.352263568453619,
     2.355408305844600,2.358553043235580,2.361697780626561,2.364842518017542,
     2.367987255408523,2.371131992799503,2.374276730190484,2.377421467581465,
     2.380566204972446,2.383710942363427,2.386855679754407,2.390000417145388,
     2.393145154536369,2.396289891927350,2.399434629318330,2.402579366709311,
     2.405724104100292,2.408868841491273,2.412013578882253,2.415158316273234,
     2.418303053664215,2.421447791055196,2.424592528446177,2.427737265837157,
     2.430882003228138,2.434026740619119,2.437171478010100,2.440316215401080,
     2.443460952792061,2.446605690183042,2.449750427574023,2.452895164965003,
     2.456039902355984,2.459184639746965,2.462329377137946,2.465474114528927,
     2.468618851919907,2.471763589310888,2.474908326701869,2.478053064092850,
     2.481197801483830,2.484342538874811,2.487487276265792,2.490632013656773,
     2.493776751047753,2.496921488438734,2.500066225829715,2.503210963220696,
     2.506355700611677,2.509500438002657,2.512645175393638,2.515789912784619,
     2.518934650175600,2.522079387566580,2.525224124957561,2.528368862348542,
     2.531513599739523,2.534658337130503,2.537803074521484,2.540947811912465,
     2.544092549303446,2.547237286694427,2.550382024085407,2.553526761476388,
     2.556671498867369,2.559816236258350,2.562960973649330,2.566105711040311,
     2.569250448431292,2.572395185822273,2.575539923213253,2.578684660604234,
     2.581829397995215,2.584974135386196,2.588118872777177,2.591263610168157,
     2.594408347559138,2.597553084950119,2.600697822341100,2.603842559732080,
     2.606987297123061,2.610132034514042,2.613276771905023,2.616421509296003,
     2.619566246686984,2.622710984077965,2.625855721468946,2.629000458859927,
     2.632145196250907,2.635289933641888,2.638434671032869,2.641579408423850,
     2.644724145814831,2.647868883205811,2.651013620596792,2.654158357987773,
     2.657303095378754,2.660447832769735,2.663592570160715,2.666737307551696,
     2.669882044942677,2.673026782333658,2.676171519724639,2.679316257115619,
     2.682460994506600,2.685605731897581,2.688750469288562,2.691895206679542,
     2.695039944070523,2.698184681461504,2.701329418852485,2.704474156243466,
     2.707618893634446,2.710763631025427,2.713908368416408,2.717053105807389,
     2.720197843198369,2.723342580589350,2.726487317980331,2.729632055371312,
     2.732776792762292,2.735921530153273,2.739066267544254,2.742211004935235,
     2.745355742326216,2.748500479717196,2.751645217108177,2.754789954499158,
     2.757934691890139,2.761079429281119,2.764224166672100,2.767368904063081,
     2.770513641454062,2.773658378845042,2.776803116236023,2.779947853627004,
     2.783092591017985,2.786237328408966,2.789382065799946,2.792526803190927,
     2.795671540581908,2.798816277972889,2.801961015363869,2.805105752754850,
     2.808250490145831,2.811395227536812,2.814539964927792,2.817684702318773,
     2.820829439709754,2.823974177100735,2.827118914491716,2.830263651882696,
     2.833408389273677,2.836553126664658,2.839697864055639,2.842842601446619,
     2.845987338837600,2.849132076228581,2.852276813619562,2.855421551010542,
     2.858566288401523,2.861711025792504,2.864855763183485,2.868000500574466,
     2.871145237965446,2.874289975356427,2.877434712747408,2.880579450138389,
     2.883724187529369,2.886868924920350,2.890013662311331,2.893158399702312,
     2.896303137093292,2.899447874484273,2.902592611875254,2.905737349266235,
     2.908882086657216,2.912026824048196,2.915171561439177,2.918316298830158,
     2.921461036221139,2.924605773612119,2.927750511003100,2.930895248394081,
     2.934039985785062,2.937184723176042,2.940329460567023,2.943474197958004,
     2.946618935348985,2.949763672739966,2.952908410130946,2.956053147521927,
     2.959197884912908,2.962342622303889,2.965487359694869,2.968632097085850,
     2.971776834476831,2.974921571867812,2.978066309258792,2.981211046649773,
     2.984355784040754,2.987500521431735,2.990645258822716,2.993789996213696,
     2.996934733604677,3.000079470995658,3.003224208386639,3.006368945777619,
     3.009513683168600,3.012658420559581,3.015803157950562,3.018947895341543,
     3.022092632732523,3.025237370123504,3.028382107514485,3.031526844905466,
     3.034671582296447,3.037816319687427,3.040961057078408,3.044105794469389,
     3.047250531860370,3.050395269251351,3.053540006642331,3.056684744033312,
     3.059829481424293,3.062974218815274,3.066118956206255,3.069263693597235,
     3.072408430988216,3.075553168379197,3.078697905770178,3.081842643161158,
     3.084987380552139,3.088132117943120,3.091276855334101,3.094421592725081,
     3.097566330116062,3.100711067507043,3.103855804898024,3.107000542289005,
     3.110145279679985,3.113290017070966,3.116434754461947,3.119579491852928,
     3.122724229243908,3.125868966634889,3.129013704025870,3.132158441416851,
     3.135303178807831,3.138447916198812,3.141592653589793};

static const double us[1000] = {0.000000000000000,
     0.000000000000123,0.000000000003937,0.000000000029893,0.000000000125965,
     0.000000000384398,0.000000000956455,0.000000002067150,0.000000004029962,
     0.000000007261541,0.000000012296383,0.000000019801490,0.000000030590997,
     0.000000045640778,0.000000066103009,0.000000093320710,0.000000128842236,
     0.000000174435732,0.000000232103552,0.000000304096619,0.000000392928744,
     0.000000501390891,0.000000632565385,0.000000789840067,0.000000976922384,
     0.000001197853415,0.000001457021837,0.000001759177815,0.000002109446824,
     0.000002513343396,0.000002976784789,0.000003506104579,0.000004108066161,
     0.000004789876177,0.000005559197844,0.000006424164200,0.000007393391251,
     0.000008475991025,0.000009681584525,0.000011020314583,0.000012502858605,
     0.000014140441221,0.000015944846808,0.000017928431920,0.000020104137590,
     0.000022485501522,0.000025086670164,0.000027922410651,0.000031008122641,
     0.000034359850003,0.000037994292395,0.000041928816696,0.000046181468317,
     0.000050770982363,0.000055716794670,0.000061039052689,0.000066758626234,
     0.000072897118087,0.000079476874446,0.000086520995233,0.000094053344246,
     0.000102098559156,0.000110682061350,0.000119830065616,0.000129569589665,
     0.000139928463493,0.000150935338579,0.000162619696914,0.000175011859866,
     0.000188142996868,0.000202045133943,0.000216751162046,0.000232294845234,
     0.000248710828662,0.000266034646392,0.000284302729026,0.000303552411155,
     0.000323821938621,0.000345150475597,0.000367578111474,0.000391145867561,
     0.000415895703597,0.000441870524061,0.000469114184299,0.000497671496447,
     0.000527588235160,0.000558911143142,0.000591687936478,0.000625967309760,
     0.000661798941014,0.000699233496423,0.000738322634845,0.000779119012120,
     0.000821676285178,0.000866049115928,0.000912293174949,0.000960465144959,
     0.001010622724077,0.001062824628875,0.001117130597213,0.001173601390854,
     0.001232298797876,0.001293285634856,0.001356625748841,0.001422384019102,
     0.001490626358664,0.001561419715629,0.001634832074257,0.001710932455852,
     0.001789790919404,0.001871478562022,0.001956067519143,0.002043630964511,
     0.002134243109940,0.002227979204851,0.002324915535584,0.002425129424480,
     0.002528699228753,0.002635704339119,0.002746225178210,0.002860343198763,
     0.002978140881579,0.003099701733253,0.003225110283692,0.003354452083388,
     0.003487813700483,0.003625282717592,0.003766947728416,0.003912898334117,
     0.004063225139470,0.004218019748796,0.004377374761665,0.004541383768371,
     0.004710141345189,0.004883743049405,0.005062285414121,0.005245865942839,
     0.005434583103822,0.005628536324229,0.005827825984032,0.006032553409713,
     0.006242820867736,0.006458731557800,0.006680389605877,0.006907900057027,
     0.007141368867995,0.007380902899594,0.007626609908873,0.007878598541062,
     0.008136978321314,0.008401859646222,0.008673353775134,0.008951572821250,
     0.009236629742510,0.009528638332275,0.009827713209797,0.010133969810485,
     0.010447524375965,0.010768493943931,0.011096996337800,0.011433150156160,
     0.011777074762019,0.012128890271856,0.012488717544474,0.012856678169654,
     0.013232894456619,0.013617489422299,0.014010586779412,0.014412310924348,
     0.014822786924867,0.015242140507611,0.015670498045431,0.016107986544528,
     0.016554733631416,0.017010867539704,0.017476517096698,0.017951811709826,
     0.018436881352896,0.018931856552175,0.019436868372295,0.019952048402001,
     0.020477528739721,0.021013441978980,0.021559921193646,0.022117099923019,
     0.022685112156761,0.023264092319670,0.023854175256299,0.024455496215425,
     0.025068190834367,0.025692395123157,0.026328245448571,0.026975878518007,
     0.027635431363231,0.028307041323987,0.028990846031461,0.029686983391621,
     0.030395591568426,0.031116808966902,0.031850774216092,0.032597626151893,
     0.033357503799755,0.034130546357281,0.034916893176695,0.035716683747207,
     0.036530057677266,0.037357154676700,0.038198114538759,0.039053077122049,
     0.039922182332367,0.040805570104448,0.041703380383600,0.042615753107269,
     0.043542828186494,0.044484745487297,0.045441644811968,0.046413665880292,
     0.047400948310678,0.048403631601230,0.049421855110735,0.050455758039590,
     0.051505479410654,0.052571158050049,0.053652932567889,0.054750941338959,
     0.055865322483341,0.056996213846978,0.058143752982208,0.059308077128233,
     0.060489323191559,0.061687627726392,0.062903126915001,0.064135956548040,
     0.065386252004850,0.066654148233724,0.067939779732161,0.069243280527080,
     0.070564784155037,0.071904423642411,0.073262331485585,0.074638639631120,
     0.076033479455920,0.077446981747395,0.078879276683625,0.080330493813528,
     0.081800762037036,0.083290209585277,0.084798964000777,0.086327152117666,
     0.087874900041921,0.089442333131613,0.091029575977192,0.092636752381797,
     0.094263985341594,0.095911397026156,0.097579108758875,0.099267240997414,
     0.100975913314215,0.102705244377036,0.104455351929554,0.106226352772012,
     0.108018362741929,0.109831496694863,0.111665868485245,0.113521590947268,
     0.115398775875856,0.117297534007699,0.119217975002362,0.121160207423475,
     0.123124338720003,0.125110475207598,0.127118722050045,0.129149183240787,
     0.131201961584553,0.133277158679078,0.135374874896922,0.137495209367390,
     0.139638259958559,0.141804123259414,0.143992894562091,0.146204667844236,
     0.148439535751480,0.150697589580035,0.152978919259410,0.155283613335254,
     0.157611758952326,0.159963441837594,0.162338746283475,0.164737755131203,
     0.167160549754336,0.169607210042416,0.172077814384759,0.174572439654403,
     0.177091161192201,0.179634052791070,0.182201186680388,0.184792633510562,
     0.187408462337742,0.190048740608710,0.192713534145925,0.195402907132746,
     0.198116922098817,0.200855639905630,0.203619119732264,0.206407419061297,
     0.209220593664908,0.212058697591152,0.214921783150424,0.217809900902114,
     0.220723099641450,0.223661426386529,0.226624926365547,0.229613643004225,
     0.232627617913435,0.235666890877025,0.238731499839846,0.241821480895989,
     0.244936868277225,0.248077694341658,0.251243989562587,0.254435782517583,
     0.257653099877779,0.260895966397384,0.264164404903407,0.267458436285610,
     0.270778079486681,0.274123351492633,0.277494267323424,0.280890840023819,
     0.284313080654463,0.287760998283206,0.291234599976647,0.294733890791917,
     0.298258873768701,0.301809549921500,0.305385918232124,0.308987975642433,
     0.312615717047325,0.316269135287954,0.319948221145210,0.323652963333431,
     0.327383348494373,0.331139361191430,0.334920983904091,0.338728197022668,
     0.342560978843263,0.346419305562993,0.350303151275472,0.354212487966549,
     0.358147285510297,0.362107511665271,0.366093132071015,0.370104110244834,
     0.374140407578826,0.378201983337175,0.382288794653710,0.386400796529717,
     0.390537941832028,0.394700181291368,0.398887463500962,0.403099734915419,
     0.407336939849873,0.411599020479397,0.415885916838676,0.420197566821960,
     0.424533906183272,0.428894868536892,0.433280385358110,0.437690385984246,
     0.442124797615934,0.446583545318686,0.451066552024719,0.455573738535050,
     0.460105023521865,0.464660323531158,0.469239552985634,0.473842624187885,
     0.478469447323842,0.483119930466484,0.487793979579822,0.492491498523160,
     0.497212389055608,0.501956550840881,0.506723881452352,0.511514276378383,
     0.516327629027914,0.521163830736330,0.526022770771585,0.530904336340596,
     0.535808412595902,0.540734882642587,0.545683627545467,0.550654526336543,
     0.555647456022711,0.560662291593742,0.565698906030512,0.570757170313506,
     0.575836953431569,0.580938122390920,0.586060542224428,0.591204076001136,
     0.596368584836048,0.601553927900164,0.606759962430773,0.611986543741996,
     0.617233525235581,0.622500758411943,0.627788092881461,0.633095376376016,
     0.638422454760772,0.643769172046212,0.649135370400403,0.654520890161515,
     0.659925569850572,0.665349246184446,0.670791754089084,0.676252926712973,
     0.681732595440840,0.687230589907579,0.692746738012414,0.698280865933286,
     0.703832798141469,0.709402357416414,0.714989364860808,0.720593639915863,
     0.726215000376820,0.731853262408668,0.737508240562089,0.743179747789601,
     0.748867595461926,0.754571593384557,0.760291549814546,0.766027271477479,
     0.771778563584669,0.777545229850544,0.783327072510232,0.789123892337345,
     0.794935488661958,0.800761659388776,0.806602201015494,0.812456908651342,
     0.818325576035816,0.824207995557591,0.830103958273608,0.836013253928354,
     0.841935670973299,0.847870996586512,0.853819016692452,0.859779515981921,
     0.865752277932179,0.871737084827227,0.877733717778245,0.883741956744189,
     0.889761580552540,0.895792366920205,0.901834092474569,0.907886532774685,
     0.913949462332615,0.920022654634909,0.926105882164217,0.932198916421040,
     0.938301527945612,0.944413486339907,0.950534560289774,0.956664517587198,
     0.962803125152673,0.968950149057700,0.975105354547390,0.981268506063191,
     0.987439367265704,0.993617701057622,0.999803269606762,1.005995834369192,
     1.012195156112462,1.018400994938921,1.024613110309128,1.030831261065344,
     1.037055205455110,1.043284701154907,1.049519505293889,1.055759374477688,
     1.062004064812297,1.068253331928009,1.074506931003435,1.080764616789563,
     1.087026143633895,1.093291265504622,1.099559736014858,1.105831308446922,
     1.112105735776662,1.118382770697818,1.124662165646431,1.130943672825276,
     1.137227044228335,1.143512031665294,1.149798386786066,1.156085861105335,
     1.162374206027118,1.168663172869341,1.174952512888432,1.181241977303912,
     1.187531317323003,1.193820284165227,1.200108629087009,1.206396103406278,
     1.212682458527050,1.218967445964010,1.225250817367069,1.231532324545913,
     1.237811719494526,1.244088754415683,1.250363181745422,1.256634754177487,
     1.262903224687723,1.269168346558449,1.275429873402781,1.281687559188910,
     1.287941158264335,1.294190425380048,1.300435115714657,1.306674984898456,
     1.312909789037437,1.319139284737234,1.325363229127001,1.331581379883216,
     1.337793495253423,1.343999334079882,1.350198655823152,1.356391220585582,
     1.362576789134722,1.368755122926641,1.374925984129153,1.381089135644954,
     1.387244341134644,1.393391365039671,1.399529972605146,1.405659929902570,
     1.411781003852438,1.417892962246732,1.423995573771304,1.430088608028128,
     1.436171835557436,1.442245027859729,1.448307957417659,1.454360397717775,
     1.460402123272139,1.466432909639805,1.472452533448156,1.478460772414099,
     1.484457405365117,1.490442212260165,1.496414974210423,1.502375473499892,
     1.508323493605833,1.514258819219046,1.520181236263990,1.526090531918736,
     1.531986494634754,1.537868914156528,1.543737581541002,1.549592289176850,
     1.555432830803568,1.561259001530386,1.567070597854999,1.572867417682112,
     1.578649260341800,1.584415926607675,1.590167218714865,1.595902940377798,
     1.601622896807787,1.607326894730419,1.613014742402743,1.618686249630255,
     1.624341227783676,1.629979489815525,1.635600850276481,1.641205125331537,
     1.646792132775931,1.652361692050875,1.657913624259059,1.663447752179930,
     1.668963900284765,1.674461894751504,1.679941563479371,1.685402736103260,
     1.690845244007898,1.696268920341772,1.701673600030829,1.707059119791942,
     1.712425318146132,1.717772035431572,1.723099113816329,1.728406397310883,
     1.733693731780402,1.738960964956764,1.744207946450348,1.749434527761571,
     1.754640562292180,1.759825905356296,1.764990414191208,1.770133947967916,
     1.775256367801424,1.780357536760776,1.785437319878838,1.790495584161832,
     1.795532198598603,1.800547034169633,1.805539963855802,1.810510862646878,
     1.815459607549758,1.820386077596442,1.825290153851748,1.830171719420759,
     1.835030659456014,1.839866861164431,1.844680213813962,1.849470608739992,
     1.854237939351463,1.858982101136736,1.863702991669185,1.868400510612522,
     1.873074559725861,1.877725042868502,1.882351866004459,1.886954937206711,
     1.891534166661186,1.896089466670479,1.900620751657295,1.905127938167626,
     1.909610944873658,1.914069692576411,1.918504104208099,1.922914104834234,
     1.927299621655453,1.931660584009073,1.935996923370385,1.940308573353668,
     1.944595469712947,1.948857550342471,1.953094755276926,1.957307026691383,
     1.961494308900977,1.965656548360316,1.969793693662628,1.973905695538635,
     1.977992506855169,1.982054082613519,1.986090379947511,1.990101358121329,
     1.994086978527073,1.998047204682047,2.001982002225795,2.005891338916872,
     2.009775184629352,2.013633511349082,2.017466293169677,2.021273506288254,
     2.025055129000915,2.028811141697972,2.032541526858914,2.036246269047135,
     2.039925354904390,2.043578773145020,2.047206514549911,2.050808571960221,
     2.054384940270844,2.057935616423643,2.061460599400428,2.064959890215698,
     2.068433491909138,2.071881409537882,2.075303650168526,2.078700222868920,
     2.082071138699712,2.085416410705663,2.088736053906735,2.092030085288938,
     2.095298523794961,2.098541390314566,2.101758707674762,2.104950500629757,
     2.108116795850686,2.111257621915120,2.114373009296355,2.117462990352499,
     2.120527599315319,2.123566872278909,2.126580847188119,2.129569563826798,
     2.132533063805815,2.135471390550894,2.138384589290230,2.141272707041921,
     2.144135792601193,2.146973896527436,2.149787071131048,2.152575370460081,
     2.155338850286715,2.158077568093527,2.160791583059599,2.163480956046420,
     2.166145749583635,2.168786027854603,2.171401856681783,2.173993303511957,
     2.176560437401275,2.179103329000143,2.181622050537942,2.184116675807586,
     2.186587280149929,2.189033940438009,2.191456735061142,2.193855743908869,
     2.196231048354750,2.198582731240019,2.200910876857090,2.203215570932934,
     2.205496900612309,2.207754954440865,2.209989822348109,2.212201595630253,
     2.214390366932931,2.216556230233786,2.218699280824955,2.220819615295423,
     2.222917331513266,2.224992528607792,2.227045306951558,2.229075768142300,
     2.231084014984746,2.233070151472342,2.235034282768869,2.236976515189983,
     2.238896956184645,2.240795714316488,2.242672899245077,2.244528621707100,
     2.246362993497481,2.248176127450416,2.249968137420332,2.251739138262790,
     2.253489245815308,2.255218576878129,2.256927249194930,2.258615381433470,
     2.260283093166189,2.261930504850751,2.263557737810548,2.265164914215152,
     2.266752157060732,2.268319590150424,2.269867338074679,2.271395526191568,
     2.272904280607067,2.274393728155309,2.275863996378817,2.277315213508720,
     2.278747508444950,2.280161010736425,2.281555850561225,2.282932158706760,
     2.284290066549934,2.285629706037308,2.286951209665264,2.288254710460184,
     2.289540341958620,2.290808238187495,2.292058533644305,2.293291363277344,
     2.294506862465953,2.295705167000786,2.296886413064112,2.298050737210136,
     2.299198276345367,2.300329167709004,2.301443548853385,2.302541557624456,
     2.303623332142296,2.304689010781690,2.305738732152755,2.306772635081609,
     2.307790858591115,2.308793541881667,2.309780824312053,2.310752845380376,
     2.311709744705048,2.312651662005850,2.313578737085076,2.314491109808745,
     2.315388920087897,2.316272307859978,2.317141413070296,2.317996375653586,
     2.318837335515644,2.319664432515079,2.320477806445138,2.321277597015651,
     2.322063943835064,2.322836986392590,2.323596864040452,2.324343715976252,
     2.325077681225443,2.325798898623918,2.326507506800724,2.327203644160885,
     2.327887448868358,2.328559058829113,2.329218611674338,2.329866244743774,
     2.330502095069187,2.331126299357978,2.331738993976920,2.332340314936046,
     2.332930397872675,2.333509378035584,2.334077390269326,2.334634568998699,
     2.335181048213364,2.335716961452623,2.336242441790344,2.336757621820050,
     2.337262633640171,2.337757608839449,2.338242678482519,2.338717973095647,
     2.339183622652640,2.339639756560928,2.340086503647817,2.340523992146914,
     2.340952349684734,2.341371703267479,2.341782179267997,2.342183903412933,
     2.342577000770046,2.342961595735726,2.343337812022690,2.343705772647870,
     2.344065599920488,2.344417415430326,2.344761340036185,2.345097493854544,
     2.345425996248414,2.345746965816380,2.346060520381859,2.346366776982548,
     2.346665851860069,2.346957860449835,2.347242917371094,2.347521136417211,
     2.347792630546123,2.348057511871031,2.348315891651283,2.348567880283472,
     2.348813587292751,2.349053121324350,2.349286590135318,2.349514100586468,
     2.349735758634545,2.349951669324609,2.350161936782632,2.350366664208313,
     2.350565953868116,2.350759907088523,2.350948624249505,2.351132204778224,
     2.351310747142940,2.351484348847156,2.351653106423974,2.351817115430680,
     2.351976470443548,2.352131265052875,2.352281591858228,2.352427542463928,
     2.352569207474753,2.352706676491862,2.352840038108957,2.352969379908653,
     2.353094788459091,2.353216349310766,2.353334146993582,2.353448265014135,
     2.353558785853226,2.353665790963592,2.353769360767865,2.353869574656761,
     2.353966510987493,2.354060247082405,2.354150859227834,2.354238422673202,
     2.354323011630323,2.354404699272941,2.354483557736493,2.354559658118088,
     2.354633070476716,2.354703863833681,2.354772106173243,2.354837864443504,
     2.354901204557489,2.354962191394469,2.355020888801490,2.355077359595132,
     2.355131665563470,2.355183867468268,2.355234025047386,2.355282197017395,
     2.355328441076417,2.355372813907167,2.355415371180225,2.355456167557500,
     2.355495256695922,2.355532691251331,2.355568522882585,2.355602802255866,
     2.355635579049202,2.355666901957185,2.355696818695898,2.355725376008046,
     2.355752619668284,2.355778594488748,2.355803344324784,2.355826912080871,
     2.355849339716748,2.355870668253723,2.355890937781190,2.355910187463318,
     2.355928455545953,2.355945779363683,2.355962195347111,2.355977739030299,
     2.355992445058401,2.356006347195476,2.356019478332479,2.356031870495431,
     2.356043554853766,2.356054561728852,2.356064920602680,2.356074660126729,
     2.356083808130994,2.356092391633189,2.356100436848099,2.356107969197111,
     2.356115013317899,2.356121593074258,2.356127731566111,2.356133451139657,
     2.356138773397675,2.356143719209982,2.356148308724028,2.356152561375648,
     2.356156495899950,2.356160130342342,2.356163482069704,2.356166567781694,
     2.356169403522182,2.356172004690822,2.356174386054755,2.356176561760424,
     2.356178545345537,2.356180349751124,2.356181987333740,2.356183469877762,
     2.356184808607820,2.356186014201320,2.356187096801094,2.356188066028145,
     2.356188930994501,2.356189700316168,2.356190382126184,2.356190984087766,
     2.356191513407556,2.356191976848949,2.356192380745521,2.356192731014530,
     2.356193033170508,2.356193292338930,2.356193513269961,2.356193700352277,
     2.356193857626960,2.356193988801454,2.356194097263601,2.356194186095726,
     2.356194258088792,2.356194315756613,2.356194361350109,2.356194396871635,
     2.356194424089336,2.356194444551567,2.356194459601348,2.356194470390855,
     2.356194477895962,2.356194482930804,2.356194486162383,2.356194488125195,
     2.356194489235890,2.356194489807947,2.356194490066380,2.356194490162452,
     2.356194490188408,2.356194490192222,2.356194490192345};

static int compearth_u2beta_findPoint(const double u, const int guessIn)
{
     const double *item = NULL;
     int i, indx, guess;
     if (u <= us[0])
     {
         return 0;
     }
     if (u >= us[nbs-2])
     {
         return nbs - 2;
     }
     // Enforce bounds 
     guess = MIN(MAX(0, guessIn), nbs - 2);
     // Take a guess based on where we were
     if (u >= us[guess] && u < us[guess + 1]){return guess;}
     // Find u
     last_visited = NULL;
     item = (double *) bsearch((const void *) &u, 
                               (const void *) us,
                               nbs, sizeof(double),
                               cmp_double_ascending);
     if (item == NULL)
     {
         item = (const double *) last_visited;
         indx = (int) (item - us);
         // Might be done early
         if (u >= us[indx] && u < us[indx+1]){return MIN(indx, nbs-2);}
         if (indx > 0)
         {
             if (u >= us[indx-1] && u < us[indx]){return MIN(indx-1, nbs-2);}
         }
         // Linearly search
         for (i=0; i<nbs-1; i++)
         {
             if (u >= us[i] && u < us[i+1])
             {
                 return i;
             }
         }
     }
     // Exactly matches
     else
     {
         indx = (int) (item - us);
     }
     indx = MIN(indx, nbs - 2); // Make interpolation work
     if (u < us[indx] || u >= us[indx+1])
     {
         // Linearly search
         for (i=0; i<nbs; i++)
         {
             if (u >= us[i] && u < us[i+1]){indx = i; break;}
         }
         if (u < us[indx] || u >= us[indx+1])
         {
             fprintf(stderr, "%s: Algorithm failure: %f not in [%f,%f]\n",
                      __func__, u, us[indx], us[indx+1]);
             return -1;
         }
     }
     return indx;
}

static void compearth_u2beta_linearlyInterpolate(const int nb,
                                                 const double *__restrict__ u,
                                                 const int *__restrict__ indx,
                                                 double *__restrict__ b)
{
     double  x0, x1, y0, y1;
     int i, loc;
     // Linearly interpolate
     #pragma omp simd
     for (i=0; i<nb; i++)
     {
         loc = indx[i];
         x0 = us[loc];
         x1 = us[loc+1];
         y0 = betas[loc];
         y1 = betas[loc+1];
         b[i] = y0 + ((u[i] - x0)*(y1 - y0))/(x1 - x0); 
     }
     return;
}
